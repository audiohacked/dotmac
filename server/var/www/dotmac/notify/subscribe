#!/usr/bin/perl

## Copyright (C) 2005 Walinsky
## This program is free software; you can redistribute it and/or modify it
## under the terms of the GNU General Public License as published by the 
## Free Software Foundation; either version 2 of the License, or (at your option)
## any later version.

=begin subscription.add
<?xml version="1.0" encoding="UTF-8"?>
  <methodCall>
    <methodName>subscription.add</methodName>
    <params>
      <param>
          <value>
            <array>
              <data>
                <value>
                  <struct>
                    <member>
                      <name>uri</name>
                        <value>
                          <string>http://idisk.mac.com/walinsky</string>
                        </value>
                    </member>
                    <member>
                      <name>principal</name>
                        <value>
                          <string>walinsky@mac.com</string>
                        </value>
                    </member>
                    <member>
                      <name>scopename</name>
                        <value>
                          <string>com.apple.MirrorAgent</string>
                        </value>
                    </member>
                    <member>
                      <name>tag</name>
                        <value>
                          <string>IDQLV/2bqa9/5L6+zdEIQw==:O8ORUsjPSpDU0fQAKEVtkw9Oq+U=</string>
                        </value>
                    </member>
                  </struct>
                </value>
              </data>
            </array>
          </value>
      </param>
    </params>
  </methodCall>

<?xml version="1.0" encoding="ISO-8859-1"?><methodResponse><params><param><value><struct><member><name>resultCode</name><value>Success</value></member><member><name>timestamp</name><value>1179431704</value></member><member><name>resultBody</name><value><array><data><value>Success</value></data></array></value></member></struct></value></param></params></methodResponse>
or
<?xml version="1.0" encoding="ISO-8859-1"?><methodResponse><params><param><value><struct><member><name>resultCode</name><value>Success</value></member><member><name>timestamp</name><value>1184949796</value></member><member><name>resultBody</name><value><array><data><value>Success</value></data></array></value></member></struct></value></param></params></methodResponse>
=end subscription.add

=begin subscription.list
<?xml version="1.0" encoding="UTF-8"?>

  <methodCall>

    <methodName>subscription.list</methodName>

    <params>

      <param>

          <value>

            <string>JUqUi8Fe13zzMjgKupDYBg==</string>

          </value>

      </param>

    </params>

  </methodCall>

<?xml version="1.0" encoding="ISO-8859-1"?><methodResponse><params><param><value><struct><member><name>resultCode</name><value>Success</value></member><member><name>timestamp</name><value>1184949797</value></member><member><name>resultBody</name><value><array><data></data></array></value></member></struct></value></param></params></methodResponse>
=end subscription.list

<?xml version="1.0" encoding="UTF-8"?>
  <methodCall>
    <methodName>subscription.resolvetags</methodName>
    <params>
      <param>
          <value>
            <array>
              <data>
                <value>
                  <string>FNDsFgPZKklqk8MaoPdMzQ==:mJUkQdOztjQIat3/jjqL56wr+Fo=</string>
                </value>
                <value>
                  <string>zX/XRgsCHLefKyZtRa5R6w==:5m7ybNZQpGxUoqGeVKe+XnsKHUs=</string>
                </value>
                <value>
                  <string>uo7xe/3lwq2hZt1CCosu1w==:0KD+EgPaucySKyOra3ZAugs6OJk=</string>
                </value>
                <value>
                  <string>Q4lzWHdtFN/shrgaQx3hJw==:W4SnYCsTabpIt2LU4gCsrd7VFlo=</string>
                </value>
                <value>
                  <string>3IFH2l+aQRNyHisdjSm5nQ==:wTt9cp9PaHUZ3XL253MSJTJCqWY=</string>
                </value>
              </data>
            </array>
          </value>
      </param>
    </params>
  </methodCall>

<?xml version="1.0" encoding="ISO-8859-1"?><methodResponse><params><param><value><struct><member><name>resultCode</name><value>Success</value></member><member><name>timestamp</name><value>1179431703</value></member><member><name>resultBody</name><value><array><data><value><struct><member><name>uri</name><value>com.apple.MailAccounts</value></member><member><name>lastcheck</name><value>0</value></member><member><name>tag</name><value>FNDsFgPZKklqk8MaoPdMzQ==:mJUkQdOztjQIat3/jjqL56wr+Fo=</value></member><member><name>principal</name><value>walinsky@mac.com</value></member><member><name>scopename</name><value>com.apple.dotmacsync.notification.com.apple.MailAccounts</value></member></struct></value><value><struct><member><name>uri</name><value>com.microsoft.entourage.Notes</value></member><member><name>lastcheck</name><value>0</value></member><member><name>tag</name><value>zX/XRgsCHLefKyZtRa5R6w==:5m7ybNZQpGxUoqGeVKe+XnsKHUs=</value></member><member><name>principal</name><value>walinsky@mac.com</value></member><member><name>scopename</name><value>com.apple.dotmacsync.notification.com.microsoft.entourage.Notes</value></member></struct></value><value><struct><member><name>lastmodifier</name><value>scjMr49iCYqORguM4+5z1g==</value></member><member><name>uri</name><value>com.apple.Calendars</value></member><member><name>lastcheck</name><value>1169598050</value></member><member><name>tag</name><value>uo7xe/3lwq2hZt1CCosu1w==:0KD+EgPaucySKyOra3ZAugs6OJk=</value></member><member><name>principal</name><value>walinsky@mac.com</value></member><member><name>scopename</name><value>com.apple.dotmactranslatorsync.notification.com.apple.Calendars</value></member></struct></value><value><struct><member><name>uri</name><value>com.apple.Keychain</value></member><member><name>lastcheck</name><value>0</value></member><member><name>tag</name><value>Q4lzWHdtFN/shrgaQx3hJw==:W4SnYCsTabpIt2LU4gCsrd7VFlo=</value></member><member><name>principal</name><value>walinsky@mac.com</value></member><member><name>scopename</name><value>com.apple.dotmacsync.notification.com.apple.Keychain</value></member></struct></value><value><struct><member><name>uri</name><value>com.apple.MailConfiguration</value></member><member><name>lastcheck</name><value>0</value></member><member><name>tag</name><value>3IFH2l+aQRNyHisdjSm5nQ==:wTt9cp9PaHUZ3XL253MSJTJCqWY=</value></member><member><name>principal</name><value>walinsky@mac.com</value></member><member><name>scopename</name><value>com.apple.dotmacsync.notification.com.apple.MailConfiguration</value></member></struct></value></data></array></value></member></struct></value></param></params></methodResponse>

<?xml version="1.0" encoding="UTF-8"?>
  <methodCall>
    <methodName>subscription.changedtags</methodName>
    <params>
      <param>
          <value>
            <string>0</string>
          </value>
      </param>
      <param>
          <value>
            <string>1178614544</string>
          </value>
      </param>
    </params>
  </methodCall>
<?xml version="1.0" encoding="ISO-8859-1"?><methodResponse><params><param><value><struct><member><name>resultCode</name><value>Success</value></member><member><name>timestamp</name><value>1179431702</value></member><member><name>resultBody</name><value><array><data><value>FNDsFgPZKklqk8MaoPdMzQ==:mJUkQdOztjQIat3/jjqL56wr+Fo=</value><value>zX/XRgsCHLefKyZtRa5R6w==:5m7ybNZQpGxUoqGeVKe+XnsKHUs=</value><value>uo7xe/3lwq2hZt1CCosu1w==:0KD+EgPaucySKyOra3ZAugs6OJk=</value><value>Q4lzWHdtFN/shrgaQx3hJw==:W4SnYCsTabpIt2LU4gCsrd7VFlo=</value><value>bM6xvsdq3QHGXaDpUYHpQg==:X3dIK3AMk+pp6Oyh3Jhp9tuv+Ag=</value><value>942j8ItIWhs8GssX6K98/w==:z9TwrPxh/8Ok+RaxpUovGKEggvc=</value><value>3IFH2l+aQRNyHisdjSm5nQ==:wTt9cp9PaHUZ3XL253MSJTJCqWY=</value></data></array></value></member></struct></value></param></params></methodResponse>
or
<?xml version="1.0" encoding="ISO-8859-1"?><methodResponse><params><param><value><struct><member><name>resultCode</name><value>Success</value></member><member><name>timestamp</name><value>1179431716</value></member><member><name>resultBody</name><value><array><data></data></array></value></member></struct></value></param></params></methodResponse>
=cut

# here goes

use XML::DOM;
$logFile="logfile";
my $TimeStamp = time();
# we should check if it's a post message
if ($ENV{'REQUEST_METHOD'} eq 'POST') {
	read(STDIN, $my_data, $ENV{'CONTENT_LENGTH'});
	}
# instantiate parser
$xp = new XML::DOM::Parser();
# parse and create tree
$doc = $xp->parse($my_data);
# get root node
$root = $doc->getDocumentElement();
my $strings = $root->getElementsByTagName("methodName");
my $n = $strings->getLength;
for (my $i = 0; $i < $n; $i++)
 {
	my $string = $strings->item ($i)->getFirstChild()->getData;
	if ($string eq "subscription.list") {
		$answer = "<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><methodResponse><params><param><value><struct><member><name>resultCode</name><value>Success</value></member><member><name>timestamp</name><value>$TimeStamp</value></member><member><name>resultBody</name><value><array><data></data></array></value></member></struct></value></param></params></methodResponse>";
		}
	elsif ($string eq "subscription.add") {
		$answer = "<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><methodResponse><params><param><value><struct><member><name>resultCode</name><value>Success</value></member><member><name>timestamp</name><value>$TimeStamp</value></member><member><name>resultBody</name><value><array><data><value>Success</value></data></array></value></member></struct></value></param></params></methodResponse>";
		}
	elsif ($string eq "subscription.changedtags") {
		$answer = "<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?><methodResponse><params><param><value><struct><member><name>resultCode</name><value>Success</value></member><member><name>timestamp</name><value>$TimeStamp</value></member><member><name>resultBody</name><value><array><data></data></array></value></member></struct></value></param></params></methodResponse>";
		}
 }
	
# set up HTML page
print "Content-Type: text/xml\n\n";

print $answer;

# uncheck following 3 lines if you want to record to your log File
open(LOGGER,">>$logFile") || `cat /dev/null > $logFile;chmod 666 $logFile`;
print LOGGER "indata was:\n".$my_data."\nI gave 'em \n".$answer."\n\n";
close(LOGGER);